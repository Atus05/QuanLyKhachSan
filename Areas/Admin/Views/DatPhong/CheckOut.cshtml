@model QuanLyKhachSan.Models.DatPhong

@{
    ViewBag.Title = "Thanh toán & Check-out";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    // Biến này sẽ được tính toán và truyền từ Controller (DatPhongController)
    decimal tongTienPhaiTra = (decimal)ViewBag.TongTienFinal;
}

<h2>Thanh toán & Check-out</h2>
<h4>Đơn hàng #@Model.DatPhongId - Khách: @Model.NguoiDung.HoTen</h4>

<div class="row">
    @* Cột 1: Chi tiết đơn hàng *@
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <i class="bi bi-info-circle me-1"></i> Chi tiết sử dụng
            </div>
            <div class="card-body">
                <h5>1. Thông tin Phòng</h5>
                <p>
                    <strong>Check-in:</strong> @Model.NgayCheckIn.ToString("dd/MM/yyyy") <br />
                    <strong>Check-out dự kiến:</strong> @Model.NgayCheckOut.ToString("dd/MM/yyyy")
                </p>
                <table class="table table-sm table-bordered">
                    <thead>
                        <tr>
                            <th>Số phòng</th>
                            <th>Loại phòng</th>
                            <th>Giá/Ngày</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var dpp in Model.DatPhongPhongs)
                        {
                            <tr>
                                <td>@dpp.Phong.SoPhong</td>
                                <td>@dpp.Phong.LoaiPhong.TenLoai</td>
                                <td>@dpp.Phong.GiaPhong.ToString("N0") ₫</td>
                            </tr>
                        }
                    </tbody>
                </table>

                <h5 class="mt-4">2. Dịch vụ đã sử dụng</h5>
                @if (Model.DichVuSuDungs != null && Model.DichVuSuDungs.Any())
                {
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Dịch vụ</th>
                                <th>Giá</th>
                                <th>Số lượng</th>
                                <th>Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var dvs in Model.DichVuSuDungs)
                            {
                                <tr>
                                    <td>@dvs.DichVu.TenDichVu</td>
                                    <td>@dvs.DichVu.Gia.ToString("N0") ₫</td>
                                    <td>@dvs.SoLuong</td>
                                    <td>@((dvs.SoLuong * dvs.DichVu.Gia).ToString("N0")) ₫</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted">Chưa có dịch vụ nào được thêm.</p>
                }
            </div>
        </div>
    </div>

    @* Cột 2: Thanh toán *@
    <div class="col-lg-4">
        <div class="card shadow-lg border-success">
            <div class="card-header bg-success text-white">
                <i class="bi bi-cash-stack me-1"></i> Tổng kết Thanh toán
            </div>
            <div class="card-body">
                <p><strong>Tiền đặt cọc:</strong> <span class="float-end text-danger">- @Model.TienDatCoc.ToString("N0") ₫</span></p>
                <hr />
                <h4 class="text-success">Tổng tiền phải trả: <span class="float-end">@tongTienPhaiTra.ToString("N0") ₫</span></h4>
                <hr />

                @* Form xác nhận Check-out *@
                @using (Html.BeginForm("CheckOutConfirmed", "DatPhong", FormMethod.Post, new { onsubmit = "return validateCheckout()" }))
                {
                    @Html.AntiForgeryToken()
                    @Html.Hidden("datPhongId", Model.DatPhongId)
                    @Html.Hidden("tongTien", tongTienPhaiTra) @* Gửi tổng tiền đã tính toán *@

                    <div class="mb-3">
                        <label for="phuongThucThanhToan" class="form-label">Phương thức Thanh toán:</label>
                        <select name="phuongThucThanhToan" id="phuongThucThanhToan" class="form-select" required>
                            <option value="">--- Chọn Phương thức ---</option>
                            <option value="Tiền mặt">Tiền mặt</option>
                            <option value="Chuyển khoản">Chuyển khoản</option>
                            <option value="Thẻ tín dụng">Thẻ tín dụng</option>
                        </select>
                    </div>

                    <button type="submit" class="btn btn-success w-100 mt-3">
                        <i class="bi bi-check-circle-fill me-1"></i> XÁC NHẬN THANH TOÁN
                    </button>
                    @Html.ActionLink("Hủy bỏ", "Index", null, new { @class = "btn btn-secondary w-100 mt-2" })
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script>
        function validateCheckout() {
            var phuongThuc = $('#phuongThucThanhToan').val();
            if (phuongThuc === "") {
                alert("Vui lòng chọn Phương thức Thanh toán.");
                return false;
            }
            return confirm("Xác nhận Check-out và Thanh toán tổng cộng @tongTienPhaiTra.ToString("N0") ₫?");
        }
    </script>
}